create table csx_dw.customer_sales
(dc_code string comment '库存dc 编码',
dc_name string comment '库存dc 名称',
perform_dc_code string comment '履约dc编码',
perform_dc_name string comment '履约dc名称',
sap_dc_code string comment 'sap系统dc编码',
sap_dc_name string comment 'sap系统dc名称',
dc_company_code string comment 'DC所属公司代码',
dc_company_name string comment 'DC所属公司名称',
dc_province_code string comment 'DC所在省区编码',
dc_province_name string comment 'DC所在省区名称',
dc_city_code string comment 'DC所在城市编码',
dc_city_name string comment 'DC所在城市名称',
dc_address string comment 'DC所在地址',
customer_no string comment '客户编号',
customer_name string comment '客户名称',
child_customer_no string comment '子客户编码',
child_customer_name string comment '子客户名称',
item_channel string comment 'item销售渠道,B端、M端、S端、大宗,BBC',
first_category string comment '客户一级分类',
first_category_code string comment '客户一级分类code',
second_category string comment '客户二级分类',
second_category_code string comment '客户二级分类code',
third_category string comment '客户三级分类',
third_category_code string comment '客户三级分类code',
sales_province string comment '客户所属销售省区',
sales_province_code string comment '客户所属销售省区code',
sales_city string comment '客户所属销售城市',
sales_city_code string comment '客户所属销售城市code',
sign_time string comment '客户签约时间',
item_province_name string comment 'item客户地理省区',
item_province_code string comment 'item客户地理省区code',
item_city_name string comment 'item客户地理城市',
item_city_code string comment 'item客户地理城市编码',
payment_terms string comment '客户账期类型',
payment_days string comment '账期',
phone string comment '客户手机号',
sales_name string comment '业务员名称',
sales_id string comment '业务员id',
work_no string comment '业务员工号',
sales_phone string comment '业务员手机号',
supervisor_name string comment '主管名称',
supervisor_id string comment '主管id',
supervisor_work_no string comment '主管工号',
city_manager_name string comment '城市主管',
city_manager_id string comment '城市主管id',
city_manager_work_no string comment '城市主管工号',
item_province_manager_name string comment 'item省区主管名称',
item_province_manager_id string comment 'item省区主管id',
item_province_manager_work_no string comment 'item省区主管工号',
org_name string comment '业务员所属组织名称',
org_code string comment '业务员所属组织编码',
sales_date string comment '销售日期',
sales_channel string comment '分销渠道',
sales_channel_name string comment '分销渠道名称',
order_qty decimal(26,6) comment '下单数量',
sales_qty decimal(26,6) comment '销售数量',
sales_value decimal(26,6) comment '含税销售额',
sales_cost decimal(26,6) comment '含税销售成本',
profit decimal(26,6) comment '含税毛利',
front_profit decimal(26,6) comment '前端含税毛利',
promotion_deduction decimal(26,6) comment '含税促销扣款',
excluding_tax_sales decimal(26,6) comment '不含税销售额',
excluding_tax_cost decimal(26,6) comment '不含税销售成本',
excluding_tax_profit decimal(26,6) comment '不含税毛利',
excluding_tax_deduction decimal(26,6) comment '不含税促销扣款',
sap_origin_dc_code string comment 'sap原始dc编码',
sap_origin_dc_name string comment 'sap原始dc名称',
channel string comment '战报渠道编码',
channel_name string comment '战报渠道名称',
province_code string comment '战报省区编码',
province_name string comment '战报省区名称',
city_name string comment '战报城市名称',
city_real string comment '战报城市组名称',
cityjob string comment '战报城市组负责人',
province_manager_id string comment '战报省区负责人id',
province_manager_work_no string comment '战报省区负责人工号',
province_manager_name string comment '战报省区负责人名称'
) comment '客户销售日报表'
 partitioned by (sdt string comment'日期分区')
 --STORED AS RCFILE 
 LOCATION  'hdfs://nameservice1/user/hive/warehouse/csx_dw.db/customer_sales';


 
set mapreduce.job.queuename=caishixian;
set hive.exec.dynamic.partition=true; -- 开启动态分析
set hive.exec.dynamic.partition.mode=nonstrict; -- 动态分区模式
set hive.exec.max.dynamic.partitions.pernode=10000;-- 表示每个maper或reducer可以允许创建的最大动态分区个数
insert overwrite table csx_dw.customer_sales partition(sdt)
select dc_code	,
dc_name	,
perform_dc_code	,
perform_dc_name	,
sap_dc_code	,
sap_dc_name	,
dc_company_code	,
dc_company_name	,
dc_province_code	,
dc_province_name	,
dc_city_code	,
dc_city_name	,
dc_address	,
a.customer_no	,
customer_name	,
attribute_name  ,
child_customer_no	,
child_customer_name	,
item_channel	,
first_category	,
first_category_code	,
second_category	,
second_category_code	,
third_category	,
third_category_code	,
sales_province	,
sales_province_code	,
sales_city	,
sales_city_code	,
sign_time	,
item_province_name	,
item_province_code	,
item_city_name	,
item_city_code	,
payment_terms	,
payment_days	,
phone	,
sales_name	,
sales_id	,
work_no	,
sales_phone	,
supervisor_name	,
supervisor_id	,
supervisor_work_no	,
city_manager_name	,
city_manager_id	,
city_manager_work_no	,
item_province_manager_name	,
item_province_manager_id	,
item_province_manager_work_no	,
org_name	,
org_code	,
sales_date	,
sales_channel	,
sales_channel_name	,
sum(order_qty)order_qty	,
sum(sales_qty)sales_qty	,
sum(sales_value)sales_value	,
sum(sales_cost)sales_cost	,
sum(profit)profit	,
sum(front_profit)front_profit	,
sum(promotion_deduction)promotion_deduction	,
sum(excluding_tax_sales)excluding_tax_sales	,
sum(excluding_tax_cost)excluding_tax_cost	,
sum(excluding_tax_profit)excluding_tax_profit	,
sum(excluding_tax_deduction)excluding_tax_deduction	,
sap_origin_dc_code	,
sap_origin_dc_name	,
channel	,
channel_name	,
province_code	,
province_name	,
city_name	,
city_real	,
cityjob	,
province_manager_id	,
province_manager_work_no	,
province_manager_name,
sdt
from csx_dw.customer_sale_m a  
left outer join
(select a.customer_no,a.attribute as attribute_name from csx_dw.customer_m  a where a.sdt=regexp_replace(to_date(date_sub(current_date(),1)),'-','')) as b on a.customer_no=b.customer_no
where a.sdt>='20191201'
-- and sales_type  in('qyg','gc','anhui','sc') 
-- and sdt<=regexp_replace(to_date(date_sub(current_date(),1)),'-','')
group by
dc_code	,
dc_name	,
perform_dc_code	,
perform_dc_name	,
sap_dc_code	,
sap_dc_name	,
dc_company_code	,
dc_company_name	,
dc_province_code	,
dc_province_name	,
dc_city_code	,
dc_city_name	,
dc_address	,
a.customer_no	,
customer_name	,
child_customer_no	,
child_customer_name	,
item_channel	,
first_category	,
first_category_code	,
second_category	,
second_category_code	,
third_category	,
third_category_code	,
sales_province	,
sales_province_code	,
sales_city	,
sales_city_code	,
sign_time	,
item_province_name	,
item_province_code	,
item_city_name	,
item_city_code	,
payment_terms	,
payment_days	,
sales_name	,
work_no	,
sales_phone	,
supervisor_name	,
supervisor_work_no	,
city_manager_name	,
city_manager_work_no	,
item_province_manager_name	,
item_province_manager_work_no	,
phone,
org_name	,
org_code	,
sales_date	,
sales_channel	,
sales_channel_name	,
sap_origin_dc_code	,
sap_origin_dc_name	,
channel	,
channel_name	,
province_code	,
province_name	,
city_name	,
supervisor_id	,
city_manager_id,
city_real	,
cityjob	,
item_province_manager_id,
province_manager_id	,
province_manager_work_no	,
province_manager_name,
sales_id,attribute_name
,sdt;
