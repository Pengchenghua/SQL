-- 部队商品Top30 上海、福建、浙江
with temp_01 as 
(select  goods_code,goods_name, sales_value, profit,dense_rank()over( order by sales_value desc) as aa
from
(select  goods_code,goods_name,sum(sales_value) sales_value,sum(profit)profit,count(distinct province_code) bb
from csx_dw.dws_sale_r_d_detail
where sdt>='20211001'
and customer_no in ('18022','118602','118705','118653','118730','118961','118934','118748','118682','118654','118664',
'120090','117529','118693','118892','118897','118907','118911','118912','118913','118915','118918','119032','120123',
'120607','120704','121015','122469','122564','122579','122581','122590','122595','122600','122605','122612','122613',
'122614','122618','122619','122622','122626','122695','113758','113779','113809','113837','113850','113870','113906',
'114540','114548','114571','114613','114693','114706','114864','114900','115692','115703','116912','117114','117132',
'117133','117192','117193','117197','117198','117200','117208','117221','117226','117250','117349','117374','117384',
'117405','117424','117444','117448','117450','117596','117628','118084','118314','118396','118466','118471','118975',
'119376','119377','119402','119642','119889','119898','119932','119980','120101','120131','120220','120366','120490',
'120517','120718','120755','120930','121008','121880','122620','122738','122781','122852')
group by  goods_code,goods_name
)a where bb>1
),
 temp_02 as 
(select  province_code,province_name,goods_code,goods_name, sales_value, profit,dense_rank()over(partition by province_code order by sales_value desc) as aa
from
(select  province_code,province_name,goods_code,goods_name,sum(sales_value) sales_value,sum(profit)profit
from csx_dw.dws_sale_r_d_detail
where sdt>='20211001'
and customer_no in ('18022','118602','118705','118653','118730','118961','118934','118748','118682','118654','118664',
'120090','117529','118693','118892','118897','118907','118911','118912','118913','118915','118918','119032','120123',
'120607','120704','121015','122469','122564','122579','122581','122590','122595','122600','122605','122612','122613',
'122614','122618','122619','122622','122626','122695','113758','113779','113809','113837','113850','113870','113906',
'114540','114548','114571','114613','114693','114706','114864','114900','115692','115703','116912','117114','117132',
'117133','117192','117193','117197','117198','117200','117208','117221','117226','117250','117349','117374','117384',
'117405','117424','117444','117448','117450','117596','117628','118084','118314','118396','118466','118471','118975',
'119376','119377','119402','119642','119889','119898','119932','119980','120101','120131','120220','120366','120490',
'120517','120718','120755','120930','121008','121880','122620','122738','122781','122852')
group by  province_code,province_name,goods_code,goods_name
)a 
)
select a.*,b.* from temp_01 a left join 
temp_02 b  on a.goods_code=b.goods_code
where a.aa<31